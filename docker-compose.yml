# BuildKit enabled by default in Docker 23+
# For older versions: DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1

services:
  # ==========================================
  # INFRASTRUCTURE LAYER
  # ==========================================
  
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: iiot_mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./infrastructure/mosquitto/config:/mosquitto/config
    networks:
      - iiot_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 10s
      timeout: 3s
      retries: 2
      start_period: 5s

  # Time-Series Database
  influxdb:
    image: influxdb:1.8
    container_name: iiot_influxdb
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=factory_data
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin123
      - INFLUXDB_HTTP_AUTH_ENABLED=false
    volumes:
      - ./infrastructure/influxdb/data:/var/lib/influxdb
      - ./infrastructure/influxdb/config:/etc/influxdb
    networks:
      - iiot_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # PostgreSQL Database for User Management
  postgres:
    image: postgres:16-alpine
    container_name: iiot_postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=iiot_users
      - POSTGRES_USER=iiot_admin
      - POSTGRES_PASSWORD=iiot_db_pass_123
    volumes:
      - ./infrastructure/postgres/data:/var/lib/postgresql/data
    networks:
      - iiot_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iiot_admin -d iiot_users"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================
  # AUTHENTICATION SERVICE
  # ==========================================
  
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: iiot_auth_service
    ports:
      - "8001:8001"
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      - DATABASE_URL=postgresql://iiot_admin:iiot_db_pass_123@postgres:5432/iiot_users
      - PYTHONUNBUFFERED=1
    volumes:
      - ./services/auth-service/src:/app/src
    networks:
      - iiot_net
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 3s
      retries: 2
      start_period: 10s

  # ==========================================
  # AI ENGINE SERVICE (Brain)
  # ==========================================
  
  ai-engine:
    build:
      context: ./services/ai-engine
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: iiot_ai_engine
    ports:
      - "8000:8000"  # FastAPI
    environment:
      - INFLUX_HOST=influxdb
      - INFLUX_PORT=8086
      - INFLUX_DB=factory_data
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - PYTHONUNBUFFERED=1
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
    volumes:
      - ./services/ai-engine/src:/app/src
      - ./services/ai-engine/models:/app/models
      - ./services/ai-engine/data:/app/data
    networks:
      - iiot_net
    depends_on:
      - influxdb
      - mosquitto
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 2
      start_period: 10s

  # ==========================================
  # SIMULATOR SERVICE
  # ==========================================
  
  simulator:
    build:
      context: ./services/simulator
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: iiot_simulator
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - SIMULATION_INTERVAL=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./services/simulator:/app
    networks:
      - iiot_net
    depends_on:
      - mosquitto
    restart: unless-stopped

  # ==========================================
  # WEB FRONTEND SERVICE
  # ==========================================
  
  web-frontend:
    build:
      context: ./services/web-frontend
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: iiot_frontend
    ports:
      - "3001:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_AUTH_URL=http://localhost:8001
      - AI_ENGINE_URL=http://ai-engine:8000
      - AUTH_SERVICE_URL=http://auth-service:8001
    networks:
      - iiot_net
    depends_on:
      - ai-engine
      - auth-service
    restart: unless-stopped

  # ==========================================
  # AI Admin: Use native Tkinter app (services/ai-admin-tkinter/app.py)
  # Run locally: python services/ai-admin-tkinter/app.py

# ==========================================
# NETWORKING
# ==========================================

networks:
  iiot_net:
    driver: bridge
    name: iiot_network

# ==========================================
# VOLUMES (Optional - for persistence)
# ==========================================

volumes:
  influxdb_data:
    driver: local
